{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block content %}
  <div class="module aligned">
    <div class="module-heading">
      <h1 class="module-title">{{ title }}</h1>
    </div>

    <div class="module-content">
      <p class="help">Se calcularon las correlaciones sobre <strong>{{ selected_count }}</strong> muestras seleccionadas.</p>

      <div class="results">
        <!-- Usar las clases de tabla del admin para integración visual -->
        <div class="table-responsive">
          <div style="display:flex; gap:8px; margin-bottom:0.6rem;">
            <a id="export-csv" class="button" href="{% url export_csv_url_name %}?ids={{ selected_ids }}">Descargar CSV</a>
            <a id="export-pdf" class="button" href="{% url export_pdf_url_name %}?ids={{ selected_ids }}">Descargar PDF</a>
          </div>
          {{ correlation_table|safe }}
        </div>
      </div>

      <div class="submit-row" style="margin-top:1.25rem;">
        <a class="button" href="{% url 'admin:medidor_muestraalcohol_changelist' %}">{% trans "Volver al listado" %}</a>
      </div>
    </div>
  </div>

  <style>
    /* Pequeños ajustes para que la tabla encaje mejor en admin */
    .module-title { font-size: 1.3em; margin: 0 0 0.5rem 0; }
    .help { color: #6c6f73; margin-bottom: 0.75rem; }
    .table-responsive table { width: 100%; border-collapse: collapse; }
    .table-responsive table th, .table-responsive table td { padding: 0.5rem 0.75rem; }
    .table-responsive table thead th { background: #f5f5f5; }
    .submit-row .button { display: inline-block; padding: 6px 12px; background: #0b5ed7; color: #fff; text-decoration: none; border-radius: 3px; }
    /* Resaltar correlaciones: negativo (blue) -> 0 -> positivo (red) */
    .table-responsive table td, .table-responsive table th { transition: background-color 0.2s ease; }
    .corr-pos { color: #6b0b0b; }
    .corr-neg { color: #0b3b6b; }
  </style>
+
+  <script>
+    (function(){
+      // aplicar un heatmap simple basado en valor numérico
+      const table = document.querySelector('.table-responsive table');
+      if(!table) return;
+      const cells = table.querySelectorAll('tbody td');
+      cells.forEach(td => {
+        const v = parseFloat(td.textContent.replace(',', '.'));
+        if(isNaN(v)) return;
+        // mapear -1..1 a color
+        const absv = Math.min(1, Math.abs(v));
+        if(v > 0){
+          // rojo: rgba(203, 67, 53, alpha)
+          const alpha = 0.15 + 0.65*absv;
+          td.style.backgroundColor = `rgba(203,67,53,${alpha})`;
+          td.classList.add('corr-pos');
+        } else if(v < 0){
+          const alpha = 0.15 + 0.65*absv;
+          td.style.backgroundColor = `rgba(44,101,176,${alpha})`;
+          td.classList.add('corr-neg');
+        } else {
+          td.style.backgroundColor = 'transparent';
+        }
+      });
+    })();
+  </script>
+
+{% endblock %}
